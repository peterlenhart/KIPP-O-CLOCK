<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>KIPP O'CLOCK</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root {
      --koc-bg: #050814;
      --koc-card: #0b1120;
      --koc-border: #1f2937;
      --koc-text-main: #f9fafb;
      --koc-text-muted: #9ca3af;

      --koc-blue: rgb(0, 101, 171);
      --koc-violet: rgb(170, 0, 120);
      --koc-green: rgb(59, 165, 43);
      --koc-orange: rgb(242, 150, 0);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: radial-gradient(circle at top, #111827 0, #020617 55%);
      color: var(--koc-text-main);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: stretch;
      padding: 12px;
    }

    .app {
      width: 100%;
      max-width: 480px;
      background: var(--koc-bg);
      border-radius: 20px;
      border: 1px solid var(--koc-border);
      box-shadow: 0 0 32px rgba(0, 0, 0, 0.75);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .app-header {
      padding: 12px 14px 10px;
      border-bottom: 1px solid var(--koc-border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .app-title-block {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .app-title {
      font-size: 1.4rem;
      font-weight: 800;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    .app-subtitle {
      font-size: 0.75rem;
      color: var(--koc-text-muted);
    }

    .points-pill {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--koc-border);
      font-size: 0.75rem;
      color: var(--koc-text-muted);
      white-space: nowrap;
    }

    .points-pill strong {
      color: #facc15;
    }

    .messenger {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: radial-gradient(circle at top, #111827 0, #020617 60%);
    }

    .chat-list {
      list-style: none;
      padding: 6px 8px 8px;
      overflow-y: auto;
      max-height: calc(100vh - 120px);
    }

    .chat-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 6px;
      border-radius: 12px;
      cursor: pointer;
      transition: background 0.12s ease-out;
    }

    .chat-item:hover {
      background: rgba(15, 23, 42, 0.8);
    }

    .chat-item.read {
      opacity: 0.8;
    }

    .avatar {
      width: 42px;
      height: 42px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      font-size: 1.1rem;
      color: #020617;
      box-shadow: 0 0 0 3px rgba(15, 23, 42, 0.7);
      flex-shrink: 0;
    }

    .chat-texts {
      flex: 1;
      min-width: 0;
    }

    .chat-top-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2px;
    }

    .chat-name {
      font-size: 0.95rem;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .chat-time {
      font-size: 0.7rem;
      color: var(--koc-text-muted);
      white-space: nowrap;
      margin-left: 6px;
    }

    .chat-preview-row {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .chat-preview {
      font-size: 0.8rem;
      color: var(--koc-text-muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .unread-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #22c55e;
      flex-shrink: 0;
    }

    .status-tag {
      font-size: 0.7rem;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid var(--koc-border);
      color: var(--koc-text-muted);
      white-space: nowrap;
    }

    .status-ok {
      color: #16a34a;
      border-color: #16a34a;
    }

    .status-fail {
      color: #f97316;
      border-color: #f97316;
    }

    /* Overlays */
    .overlay,
    .message-view {
      position: fixed;
      inset: 0;
      display: none;
      justify-content: center;
      align-items: center;
      padding: 12px;
      background: rgba(0, 0, 0, 0.85);
      z-index: 40;
    }

    .overlay-inner,
    .msg-card {
      width: 100%;
      max-width: 480px;
      background: #ffffff;
      border-radius: 20px;
      padding: 16px 16px 14px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.8);
      color: #020617;
      position: relative;
    }

    .overlay-header {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-bottom: 8px;
    }

    .overlay-avatar {
      width: 46px;
      height: 46px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      font-size: 1.2rem;
      color: #020617;
      flex-shrink: 0;
      box-shadow: 0 0 0 3px rgba(15, 23, 42, 0.15);
    }

    .overlay-title-block {
      flex: 1;
      min-width: 0;
    }

    .overlay-name {
      font-size: 1rem;
      font-weight: 700;
      margin-bottom: 2px;
    }

    .overlay-subline {
      font-size: 0.8rem;
      color: #4b5563;
    }

    .overlay-body {
      margin-top: 6px;
      font-size: 0.9rem;
      line-height: 1.45;
      color: #111827;
      max-height: 60vh;
      overflow-y: auto;
    }

    .overlay-body p {
      margin-bottom: 8px;
    }

    .overlay-body p:last-child {
      margin-bottom: 0;
    }

    .overlay-footer {
      margin-top: 12px;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    .btn {
      border-radius: 999px;
      padding: 8px 14px;
      border: none;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
    }

    .btn-secondary {
      background: #e5e7eb;
      color: #111827;
    }

    .btn-primary {
      background: #0ea5e9;
      color: #e0f2fe;
    }

    .btn-primary:active,
    .btn-secondary:active {
      transform: translateY(1px);
      filter: brightness(0.95);
    }

    .close-icon {
      position: absolute;
      top: 10px;
      right: 12px;
      font-size: 1.3rem;
      cursor: pointer;
      color: #6b7280;
    }

    .close-icon:hover {
      color: #111827;
    }

    /* Message view */
    .msg-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
      padding-bottom: 6px;
      border-bottom: 1px solid rgba(148, 163, 184, 0.4);
    }

    .msg-avatar {
      width: 40px;
      height: 40px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      font-size: 1rem;
      color: #020617;
      flex-shrink: 0;
      box-shadow: 0 0 0 3px rgba(15, 23, 42, 0.1);
    }

    .msg-header-text {
      flex: 1;
      min-width: 0;
    }

    .msg-name {
      font-size: 0.95rem;
      font-weight: 700;
    }

    .msg-time-line {
      font-size: 0.8rem;
      color: #4b5563;
      margin-top: 2px;
    }

    .msg-body {
      margin-top: 8px;
      padding: 10px 10px 8px;
      border-radius: 14px;
      background: #f9fafb;
      border: 1px solid rgba(148, 163, 184, 0.5);
      font-size: 0.9rem;
      line-height: 1.45;
      color: #111827;
    }

    .msg-body p {
      margin-bottom: 6px;
    }

    .msg-body p:last-child {
      margin-bottom: 0;
    }

    .msg-buttons {
      margin-top: 12px;
      display: flex;
      gap: 10px;
      justify-content: space-between;
    }

    .msg-btn-ok {
      flex: 1;
      background: #22c55e;
      color: #022c22;
    }

    .msg-btn-fail {
      flex: 1;
      background: #f97316;
      color: #451a03;
    }

    /* Utility */
    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="app-header">
      <div class="app-title-block">
        <div class="app-title">KIPP O'CLOCK</div>
        <div class="app-subtitle">Pünktlichkeitspunkte im Messenger-Stil</div>
      </div>
      <div class="points-pill">
        Pünktlichkeitspunkte: <strong id="points-total">0</strong> / 6
      </div>
    </header>

    <main class="messenger">
      <ul class="chat-list" id="chat-list">
        <!-- Chats werden per JS eingefügt -->
      </ul>
    </main>
  </div>

  <!-- KIPPBOX-Erklärungs-Overlay -->
  <div class="overlay" id="kippbox-overlay">
    <div class="overlay-inner">
      <div class="close-icon" id="kippbox-close">✖</div>
      <div class="overlay-header">
        <div class="overlay-avatar" id="kippbox-avatar">KB</div>
        <div class="overlay-title-block">
          <div class="overlay-name">KIPPBOX</div>
          <div class="overlay-subline">Spielerklärung für KIPP O'CLOCK</div>
        </div>
      </div>
      <div class="overlay-body">
        <p>Hallo, ich bin deine KIPPBOX.</p>
        <p>Mein Rand zeigt, wie bei einer Uhr, die Minutenangaben in Viertelstunden. Der Würfel gibt die Stunden an.</p>
        <p>Wenn du an der Reihe bist, öffnest du eine deiner Nachrichten und liest die Uhrzeit im Text. Sag danach an, wie oft du den Würfel im Uhrzeigersinn kippen möchtest.</p>
        <p>Hinweis: Nach zwölf Kippbewegungen liegt der Würfel wieder so wie am Anfang. (Gar nicht kippen ist zwölfmal kippen.)</p>
        <p>Nach deiner Ansage kippst du den Würfel genauso oft, wie du angesagt hast. Prüfe dann, ob die richtige Stunde an der richtigen Minutenangabe liegt.</p>
        <p>Hast du den Termin geschafft, klickst du „Ich bin da“ und bekommst einen Pünktlichkeitspunkt. Wenn nicht, klickst du „Hab's nicht geschafft“ und erhältst keinen Punkt.</p>
        <p>Schließe die Nachricht wieder, dein Spielzug ist abgeschlossen.</p>
      </div>
      <div class="overlay-footer">
        <button class="btn btn-primary" id="kippbox-ok-btn">Los geht's</button>
      </div>
    </div>
  </div>

  <!-- Nachrichten-Ansicht -->
  <div class="message-view hidden" id="message-view">
    <div class="msg-card" id="msg-card">
      <div class="close-icon" id="msg-close">✖</div>

      <div class="msg-header">
        <div class="msg-avatar" id="msg-avatar">A</div>
        <div class="msg-header-text">
          <div class="msg-name" id="msg-name">Name</div>
          <div class="msg-time-line" id="msg-time-line">Treffen um 10:30 Uhr</div>
        </div>
      </div>

      <div class="msg-body" id="msg-body">
        <!-- Text per JS -->
      </div>

      <div class="msg-buttons">
        <button class="btn msg-btn-ok" id="btn-ok">Ich bin da</button>
        <button class="btn msg-btn-fail" id="btn-fail">Hab's nicht geschafft</button>
      </div>
    </div>
  </div>

  <script>
    // -----------------------------
    // Datenbasis
    // -----------------------------
    const namesPool = [
      "Oma", "Opa", "Papa", "Mama",
      "Lara", "Peter", "Elke", "Selina",
      "Fabian", "Emre", "Mami",
      "Armin", "Nati", "Monika"
    ];

    const phrases = [
      "Ich zähle auf dich.",
      "Ich warte auf dich.",
      "Bitte pünktlich."
    ];

    const colors = [
      { name: "blue",   value: "rgb(0, 101, 171)" },
      { name: "violet", value: "rgb(170, 0, 120)" },
      { name: "green",  value: "rgb(59, 165, 43)" },
      { name: "orange", value: "rgb(242, 150, 0)" }
    ];

    const MIN_HOUR = 8;   // 08:00
    const MAX_HOUR = 19;  // 19:45
    const minutesSteps = ["00", "15", "30", "45"];

    // -----------------------------
    // State
    // -----------------------------
    let chats = [];
    let currentChatId = null;
    let points = 0;

    // -----------------------------
    // Hilfsfunktionen
    // -----------------------------
    function randomElement(arr) {
      return arr[Math.floor(Math.random() * arr.length)];
    }

    function randomTime() {
      const hour = MIN_HOUR + Math.floor(Math.random() * (MAX_HOUR - MIN_HOUR + 1));
      const mins = randomElement(minutesSteps);
      const hourStr = hour.toString().padStart(2, "0");
      return `${hourStr}:${mins}`;
    }

    function getInitial(name) {
      return name.trim().charAt(0).toUpperCase();
    }

    function createChats(count = 6) {
      const usedNames = [];
      const usedTimes = new Set();

      for (let i = 0; i < count; i++) {
        // Name
        let name;
        let safety = 0;
        do {
          name = randomElement(namesPool);
          safety++;
          if (safety > 50) break;
        } while (usedNames.includes(name));
        usedNames.push(name);

        // Uhrzeit eindeutig in dieser Runde
        let timeStr;
        let safetyTime = 0;
        do {
          timeStr = randomTime();
          safetyTime++;
          if (safetyTime > 100) break;
        } while (usedTimes.has(timeStr));
        usedTimes.add(timeStr);

        // Phrase
        const phrase = randomElement(phrases);

        // Farbe
        const color = colors[i % colors.length];

        const id = "chat_" + i;

        chats.push({
          id,
          name,
          initial: getInitial(name),
          timeStr,
          phrase,
          color,
          status: "unread", // unread | ok | fail
          result: null
        });
      }
    }

    function renderChatList() {
      const listEl = document.getElementById("chat-list");
      listEl.innerHTML = "";

      chats.forEach(chat => {
        const li = document.createElement("li");
        li.className = "chat-item";
        if (chat.status !== "unread") {
          li.classList.add("read");
        }
        li.dataset.chatId = chat.id;

        const avatar = document.createElement("div");
        avatar.className = "avatar";
        avatar.textContent = chat.initial;
        avatar.style.background = chat.color.value;

        const texts = document.createElement("div");
        texts.className = "chat-texts";

        const topRow = document.createElement("div");
        topRow.className = "chat-top-row";

        const nameEl = document.createElement("div");
        nameEl.className = "chat-name";
        nameEl.textContent = chat.name;

        const timeEl = document.createElement("div");
        timeEl.className = "chat-time";
        timeEl.textContent = chat.timeStr + " Uhr";

        topRow.appendChild(nameEl);
        topRow.appendChild(timeEl);

        const previewRow = document.createElement("div");
        previewRow.className = "chat-preview-row";

        const preview = document.createElement("div");
        preview.className = "chat-preview";

        if (chat.status === "ok") {
          preview.textContent = "✔ Termin geschafft.";
        } else if (chat.status === "fail") {
          preview.textContent = "✖ Termin verpasst.";
        } else {
          preview.textContent = chat.phrase;
        }

        previewRow.appendChild(preview);

        if (chat.status === "unread") {
          const dot = document.createElement("div");
          dot.className = "unread-dot";
          previewRow.appendChild(dot);
        } else {
          const tag = document.createElement("div");
          tag.className = "status-tag " + (chat.status === "ok" ? "status-ok" : "status-fail");
          tag.textContent = chat.status === "ok" ? "Pünktlich" : "Nicht pünktlich";
          previewRow.appendChild(tag);
        }

        texts.appendChild(topRow);
        texts.appendChild(previewRow);

        li.appendChild(avatar);
        li.appendChild(texts);

        li.addEventListener("click", () => openChat(chat.id));

        listEl.appendChild(li);
      });
    }

    function updatePointsDisplay() {
      const el = document.getElementById("points-total");
      el.textContent = String(points);
    }

    // -----------------------------
    // Nachricht öffnen / schließen
    // -----------------------------
    function openChat(chatId) {
      const chat = chats.find(c => c.id === chatId);
      if (!chat) return;

      currentChatId = chatId;

      const msgView = document.getElementById("message-view");
      const msgCard = document.getElementById("msg-card");
      const msgAvatar = document.getElementById("msg-avatar");
      const msgName = document.getElementById("msg-name");
      const msgTimeLine = document.getElementById("msg-time-line");
      const msgBody = document.getElementById("msg-body");

      msgAvatar.textContent = chat.initial;
      msgAvatar.style.background = chat.color.value;

      msgName.textContent = chat.name;
      msgTimeLine.textContent = `Treffen um ${chat.timeStr} Uhr`;

      msgBody.innerHTML = "";
      const p1 = document.createElement("p");
      p1.textContent = `Treffen um ${chat.timeStr} Uhr.`;
      const p2 = document.createElement("p");
      p2.textContent = chat.phrase;
      const p3 = document.createElement("p");
      p3.textContent = `Liebe Grüße, ${chat.name}.`;

      msgBody.appendChild(p1);
      msgBody.appendChild(p2);
      msgBody.appendChild(p3);

      // leichte Farbtönung im Kartenrand
      msgCard.style.border = "1px solid rgba(148,163,184,0.7)";
      msgCard.style.background = "#ffffff";

      msgView.style.display = "flex";
      msgView.classList.remove("hidden");
    }

    function closeMessageView() {
      const msgView = document.getElementById("message-view");
      msgView.style.display = "none";
      msgView.classList.add("hidden");
      currentChatId = null;
    }

    function handleResponse(type) {
      if (!currentChatId) return;
      const chat = chats.find(c => c.id === currentChatId);
      if (!chat) return;

      if (type === "ok" && chat.status !== "ok") {
        points += 1;
      }

      chat.status = type === "ok" ? "ok" : "fail";
      chat.result = type;
      updatePointsDisplay();
      renderChatList();
      closeMessageView();
    }

    // -----------------------------
    // KIPPBOX-Overlay
    // -----------------------------
    function openKippboxOverlay() {
      const overlay = document.getElementById("kippbox-overlay");
      const avatar = document.getElementById("kippbox-avatar");
      avatar.style.background = "var(--koc-blue)";
      overlay.style.display = "flex";
    }

    function closeKippboxOverlay() {
      const overlay = document.getElementById("kippbox-overlay");
      overlay.style.display = "none";
    }

    // -----------------------------
    // Init
    // -----------------------------
    function init() {
      createChats(6);
      renderChatList();
      updatePointsDisplay();
      openKippboxOverlay();

      // Events
      document.getElementById("kippbox-ok-btn").addEventListener("click", closeKippboxOverlay);
      document.getElementById("kippbox-close").addEventListener("click", closeKippboxOverlay);

      document.getElementById("msg-close").addEventListener("click", closeMessageView);
      document.getElementById("btn-ok").addEventListener("click", () => handleResponse("ok"));
      document.getElementById("btn-fail").addEventListener("click", () => handleResponse("fail"));

      // Schließen per Klick auf dunklen Rand außerhalb der Karte (optional)
      document.getElementById("message-view").addEventListener("click", (e) => {
        if (e.target.id === "message-view") {
          closeMessageView();
        }
      });
    }

    init();
  </script>
</body>
</html>
