<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>KIPP O'CLOCK</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root {
      --kc-bg: #020617;
      --kc-surface: #020617;
      --kc-list-divider: #1f2933;

      --kc-blue: rgb(0, 101, 171);
      --kc-violet: rgb(170, 0, 120);
      --kc-green: rgb(59, 165, 43);
      --kc-orange: rgb(242, 150, 0);

      --kc-text-main: #e5e7eb;
      --kc-text-muted: #94a3b8;
      --kc-text-strong: #f9fafb;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
      background: radial-gradient(circle at top, #111827 0, #020617 55%, #000 100%);
      color: var(--kc-text-main);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 16px 10px;
    }

    .app {
      width: 100%;
      max-width: 480px;
      background: var(--kc-surface);
      border-radius: 20px;
      border: 1px solid rgba(15,23,42,0.9);
      box-shadow: 0 18px 40px rgba(0,0,0,0.75);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* Header */

    .app-header {
      padding: 14px 14px 8px;
      border-bottom: 1px solid rgba(30,41,59,0.9);
      background: linear-gradient(135deg, #020617 0, #020617 35%, #0b1120 100%);
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .app-title-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
    }

    .app-title {
      font-size: 1.35rem;
      font-weight: 800;
      letter-spacing: 0.09em;
      text-transform: uppercase;
      color: var(--kc-orange);
    }

    .app-sub {
      font-size: 0.78rem;
      color: var(--kc-text-muted);
    }

    .score-row {
      margin-top: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.8rem;
      color: var(--kc-text-muted);
    }

    .score-value {
      font-weight: 700;
      color: #fbbf24;
      font-size: 0.98rem;
    }

    /* Liste */

    .chat-list {
      flex: 1;
      overflow-y: auto;
      background: #020617;
    }

    .chat-row {
      display: flex;
      align-items: center;
      padding: 10px 12px;
      border-bottom: 1px solid rgba(30,41,59,0.8);
      cursor: pointer;
      gap: 10px;
    }

    .chat-row:last-child {
      border-bottom: none;
    }

    .chat-row:hover {
      background: rgba(15,23,42,0.85);
    }

    .chat-row.read {
      opacity: 0.8;
    }

    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      font-size: 1.05rem;
      color: #020617;
      flex-shrink: 0;
      position: relative;
    }

    .avatar.blue   { background: var(--kc-blue); }
    .avatar.violet { background: var(--kc-violet); }
    .avatar.green  { background: var(--kc-green); }
    .avatar.orange { background: var(--kc-orange); }

    .avatar-unread-dot {
      position: absolute;
      bottom: -2px;
      right: -2px;
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: #22c55e;
      border: 2px solid #020617;
    }

    .chat-main {
      flex: 1;
      min-width: 0;
    }

    .chat-top {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 2px;
    }

    .chat-name {
      font-size: 0.98rem;
      font-weight: 600;
      color: var(--kc-text-strong);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .chat-name.unread {
      font-weight: 800;
    }

    .chat-meta {
      font-size: 0.68rem;
      color: var(--kc-text-muted);
      margin-left: 6px;
      white-space: nowrap;
    }

    .chat-preview {
      font-size: 0.82rem;
      color: var(--kc-text-muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .badge-new {
      font-size: 0.7rem;
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(34,197,94,0.15);
      color: #bbf7d0;
      margin-left: 8px;
    }

    .badge-done {
      font-size: 0.7rem;
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(37,99,235,0.2);
      color: #bfdbfe;
      margin-left: 8px;
    }

    .badge-miss {
      font-size: 0.7rem;
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(148,163,184,0.18);
      color: #cbd5f5;
      margin-left: 8px;
    }

    /* Overlay */

    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.72);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 40;
      padding: 18px 10px;
    }

    .overlay.visible {
      display: flex;
    }

    .msg-card {
      width: 100%;
      max-width: 420px;
      border-radius: 22px;
      overflow: hidden;
      box-shadow: 0 18px 45px rgba(0,0,0,0.9);
      border: 1px solid rgba(15,23,42,0.9);
      display: flex;
      flex-direction: column;
    }

    .msg-header {
      padding: 10px 12px 9px;
      display: flex;
      align-items: center;
      gap: 10px;
      border-bottom: 1px solid rgba(15,23,42,0.85);
      position: relative;
    }

    .msg-header-avatar {
      width: 40px;
      height: 40px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      font-size: 1.05rem;
      color: #020617;
      flex-shrink: 0;
    }

    .msg-header-main {
      flex: 1;
    }

    .msg-header-name {
      font-size: 0.95rem;
      font-weight: 700;
      color: #020617;
    }

    .msg-header-sub {
      font-size: 0.78rem;
      color: #111827;
      opacity: 0.9;
    }

    .msg-close {
      position: absolute;
      top: 9px;
      right: 10px;
      width: 26px;
      height: 26px;
      border-radius: 999px;
      border: none;
      background: rgba(15,23,42,0.4);
      color: #020617;
      font-size: 1.1rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .msg-close:hover {
      background: rgba(15,23,42,0.65);
    }

    .msg-body {
      padding: 12px 14px 10px;
      font-size: 0.94rem;
      line-height: 1.45;
      max-height: 290px;
      overflow-y: auto;
    }

    .msg-body p + p {
      margin-top: 6px;
    }

    .msg-footer {
      padding: 10px 12px 12px;
      border-top: 1px solid rgba(15,23,42,0.8);
      display: flex;
      gap: 10px;
    }

    .btn {
      border: none;
      border-radius: 999px;
      padding: 10px 10px;
      font-size: 0.9rem;
      font-weight: 700;
      cursor: pointer;
      flex: 1;
      text-align: center;
      white-space: nowrap;
    }

    .btn-primary {
      background: #22c55e;
      color: #022c22;
      border: 1px solid #16a34a;
    }

    .btn-secondary {
      background: transparent;
      color: #111827;
      border: 1px solid rgba(15,23,42,0.8);
    }

    .btn-primary:active,
    .btn-secondary:active {
      transform: translateY(1px);
      filter: brightness(0.95);
    }

    .btn-full {
      flex: 1;
    }

    .msg-footer.intro-footer {
      justify-content: center;
    }

    .msg-footer.intro-footer .btn {
      max-width: 200px;
    }

    @media (max-width: 400px) {
      .chat-row { padding: 8px 10px; }
      .avatar { width: 36px; height: 36px; font-size: 0.98rem; }
      .msg-card { max-width: 100%; }
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="app-header">
      <div class="app-title-row">
        <div class="app-title">KIPP O'CLOCK</div>
      </div>
      <div class="app-sub">
        Pünktlich mit jedem Kipp – die App verwaltet nur Uhrzeit, Punkte und Züge.
      </div>
      <div class="score-row">
        <div>Pünktlichkeitspunkte: <span id="scoreValue" class="score-value">0</span></div>
        <div>Nachrichten beantwortet: <span id="answeredCount">0</span>/6</div>
      </div>
    </header>

    <main class="chat-list" id="chatList">
      <!-- Nachrichten werden per JS eingefügt -->
    </main>
  </div>

  <!-- Overlay für Nachrichten & KIPPBOX -->
  <div class="overlay" id="overlay">
    <div class="msg-card" id="msgCard">
      <div class="msg-header" id="msgHeader">
        <div class="msg-header-avatar" id="msgAvatar"></div>
        <div class="msg-header-main">
          <div class="msg-header-name" id="msgName"></div>
          <div class="msg-header-sub" id="msgSub"></div>
        </div>
        <button class="msg-close" id="msgCloseBtn" aria-label="Nachricht schließen">×</button>
      </div>
      <div class="msg-body" id="msgBody"></div>
      <div class="msg-footer" id="msgFooter">
        <!-- Buttons per JS -->
      </div>
    </div>
  </div>

  <script>
    // ------------------------------
    // Daten & Konstanten
    // ------------------------------
    const NAME_POOL = [
      "Papa","Mama","Oma","Opa","Lara","Peter","Elke","Selina",
      "Fabian","Emre","Armin","Nati","Monika"
    ];

    const COLOR_KEYS = ["blue","violet","green","orange"];

    const CLOSING_VARIANTS = [
      "Ich zähle auf dich.",
      "Ich warte auf dich.",
      "Bitte pünktlich."
    ];

    const MINUTE_OPTIONS = ["00","15","30","45"];

    const chatListEl      = document.getElementById("chatList");
    const overlayEl       = document.getElementById("overlay");
    const msgCardEl       = document.getElementById("msgCard");
    const msgHeaderEl     = document.getElementById("msgHeader");
    const msgAvatarEl     = document.getElementById("msgAvatar");
    const msgNameEl       = document.getElementById("msgName");
    const msgSubEl        = document.getElementById("msgSub");
    const msgBodyEl       = document.getElementById("msgBody");
    const msgFooterEl     = document.getElementById("msgFooter");
    const msgCloseBtn     = document.getElementById("msgCloseBtn");

    const scoreValueEl    = document.getElementById("scoreValue");
    const answeredCountEl = document.getElementById("answeredCount");

    let messages = [];
    let punctualPoints = 0;
    let answeredMessages = 0;

    let openedMessageId = null; // null = kein Freund, "intro" = KIPPBOX

    // ------------------------------
    // Hilfsfunktionen
    // ------------------------------
    function randomElement(arr) {
      return arr[Math.floor(Math.random() * arr.length)];
    }

    function shuffle(arr) {
      const a = arr.slice();
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    function formatTime(hour, minutes) {
      const hh = hour.toString().padStart(2, "0");
      return hh + ":" + minutes;
    }

    function updateScoreDisplays() {
      scoreValueEl.textContent = String(punctualPoints);
      answeredCountEl.textContent = String(answeredMessages);
    }

    // ------------------------------
    // Nachrichten erzeugen
    // ------------------------------
    function createRandomMessages() {
      const shuffledNames = shuffle(NAME_POOL);
      const chosenNames = shuffledNames.slice(0, 6);

      messages = chosenNames.map((name, index) => {
        const colorKey = COLOR_KEYS[index % COLOR_KEYS.length];

        const hour = 8 + Math.floor(Math.random() * 12); // 8..19
        const minute = randomElement(MINUTE_OPTIONS);
        const timeStr = formatTime(hour, minute);

        const closing = randomElement(CLOSING_VARIANTS);

        const text = `Treffen um ${timeStr}. ${closing}`;

        return {
          id: index,
          name,
          colorKey,
          timeStr,
          text,
          opened: false,
          answered: false,
          punctual: false
        };
      });
    }

    // ------------------------------
    // Liste rendern
    // ------------------------------
    function renderChatList() {
      chatListEl.innerHTML = "";

      messages.forEach(msg => {
        const row = document.createElement("div");
        row.className = "chat-row" + (msg.opened ? " read" : "");
        row.dataset.id = msg.id;

        const avatar = document.createElement("div");
        avatar.className = "avatar " + msg.colorKey;
        avatar.textContent = msg.name.charAt(0).toUpperCase();

        if (!msg.opened) {
          const dot = document.createElement("div");
          dot.className = "avatar-unread-dot";
          avatar.appendChild(dot);
        }

        const main = document.createElement("div");
        main.className = "chat-main";

        const top = document.createElement("div");
        top.className = "chat-top";

        const nameEl = document.createElement("div");
        nameEl.className = "chat-name" + (!msg.opened ? " unread" : "");
        nameEl.textContent = msg.name;

        const meta = document.createElement("div");
        meta.className = "chat-meta";
        meta.textContent = msg.timeStr;

        if (!msg.answered && !msg.opened) {
          const badge = document.createElement("span");
          badge.className = "badge-new";
          badge.textContent = "neu";
          meta.appendChild(badge);
        } else if (msg.answered && msg.punctual) {
          const badge = document.createElement("span");
          badge.className = "badge-done";
          badge.textContent = "pünktlich";
          meta.appendChild(badge);
        } else if (msg.answered && !msg.punctual) {
          const badge = document.createElement("span");
          badge.className = "badge-miss";
          badge.textContent = "nicht geschafft";
          meta.appendChild(badge);
        }

        top.appendChild(nameEl);
        top.appendChild(meta);

        const preview = document.createElement("div");
        preview.className = "chat-preview";
        preview.textContent = msg.text;

        main.appendChild(top);
        main.appendChild(preview);

        row.appendChild(avatar);
        row.appendChild(main);

        row.addEventListener("click", () => openMessage(msg.id));

        chatListEl.appendChild(row);
      });
    }

    // ------------------------------
    // Overlay-Farben
    // ------------------------------
    function getColorByKey(key) {
      switch (key) {
        case "blue":   return "rgb(0, 101, 171)";
        case "violet": return "rgb(170, 0, 120)";
        case "green":  return "rgb(59, 165, 43)";
        case "orange": return "rgb(242, 150, 0)";
        default:       return "rgb(15, 23, 42)";
      }
    }

    function createTint(colorRgbString, alpha) {
      // colorRgbString: "rgb(r,g,b)"
      const m = colorRgbString.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);
      if (!m) return `rgba(15,23,42,${alpha})`;
      const r = m[1], g = m[2], b = m[3];
      return `rgba(${r},${g},${b},${alpha})`;
    }

    // ------------------------------
    // KIPPBOX-Intro anzeigen
    // ------------------------------
    function showIntro() {
      openedMessageId = "intro";

      const baseColor = getColorByKey("blue");
      const headerColor = createTint(baseColor, 0.86);
      const bodyColor   = createTint(baseColor, 0.16);

      msgHeaderEl.style.background = headerColor;
      msgBodyEl.style.background   = bodyColor;
      msgFooterEl.style.background = bodyColor;

      msgAvatarEl.style.background = baseColor;
      msgAvatarEl.textContent = "K";
      msgNameEl.textContent   = "KIPPBOX";
      msgSubEl.textContent    = "Spielerklärung für KIPP O'CLOCK";

      msgBodyEl.innerHTML = `
        <p>Hallo, ich bin deine KIPPBOX.</p>
        <p>Mein Rand zeigt, wie bei einer Uhr, die Minutenangaben in Viertelstunden. Der Würfel gibt die Stunden an.</p>
        <p>Wenn du an der Reihe bist, öffnest du eine deiner Nachrichten und liest die Uhrzeit im Text.</p>
        <p>Sag danach an, wie oft du den Würfel im Uhrzeigersinn kippen möchtest.</p>
        <p><strong>Hinweis:</strong> Nach zwölf Kippbewegungen liegt der Würfel wieder so wie am Anfang. (Gar nicht kippen ist zwölfmal kippen.)</p>
        <p>Nach deiner Ansage kippst du den Würfel genauso oft, wie du angesagt hast.</p>
        <p>Prüfe dann, ob die richtige Stunde an der richtigen Minutenangabe liegt.</p>
        <p>Hast du den Termin geschafft, klickst du „Ich bin da“ und bekommst einen Pünktlichkeitspunkt.</p>
        <p>Wenn nicht, klickst du „Hab's nicht geschafft“ und erhältst keinen Punkt.</p>
        <p>Schließe die Nachricht wieder, dein Spielzug ist abgeschlossen.</p>
      `;

      msgFooterEl.className = "msg-footer intro-footer";
      msgFooterEl.innerHTML = "";

      const okBtn = document.createElement("button");
      okBtn.className = "btn btn-primary btn-full";
      okBtn.textContent = "Verstanden";
      okBtn.addEventListener("click", closeOverlay);

      msgFooterEl.appendChild(okBtn);

      overlayEl.classList.add("visible");
    }

    // ------------------------------
    // Nachricht öffnen
    // ------------------------------
    function openMessage(id) {
      const msg = messages.find(m => m.id === id);
      if (!msg) return;

      openedMessageId = msg.id;

      msg.opened = true;

      const baseColor = getColorByKey(msg.colorKey);
      const headerColor = createTint(baseColor, 0.9);
      const bodyColor   = createTint(baseColor, 0.16);

      msgHeaderEl.style.background = headerColor;
      msgBodyEl.style.background   = bodyColor;
      msgFooterEl.style.background = bodyColor;

      msgAvatarEl.style.background = baseColor;
      msgAvatarEl.textContent = msg.name.charAt(0).toUpperCase();

      msgNameEl.textContent = msg.name;
      msgSubEl.textContent  = "Treffen um " + msg.timeStr;

      msgBodyEl.innerHTML = `
        <p>Neue Nachricht von ${msg.name}:</p>
        <p><strong>${msg.text}</strong></p>
        <p>Wenn du an der Reihe bist, lies die Uhrzeit, sag deine Kippanzahl laut an und kippe den Würfel im Uhrzeigersinn.</p>
      `;

      msgFooterEl.className = "msg-footer";
      msgFooterEl.innerHTML = "";

      const btnHere = document.createElement("button");
      btnHere.className = "btn btn-primary";
      btnHere.textContent = "Ich bin da";

      const btnMiss = document.createElement("button");
      btnMiss.className = "btn btn-secondary";
      btnMiss.textContent = "Hab's nicht geschafft";

      if (msg.answered) {
        btnHere.disabled = true;
        btnMiss.disabled = true;
      } else {
        btnHere.addEventListener("click", () => {
          handleAnswer(msg, true);
        });
        btnMiss.addEventListener("click", () => {
          handleAnswer(msg, false);
        });
      }

      msgFooterEl.appendChild(btnHere);
      msgFooterEl.appendChild(btnMiss);

      overlayEl.classList.add("visible");
      renderChatList();
      updateScoreDisplays();
    }

    // ------------------------------
    // Antwort-Logik
    // ------------------------------
    function handleAnswer(msg, punctual) {
      if (msg.answered) {
        closeOverlay();
        return;
      }

      msg.answered = true;
      msg.punctual = punctual;

      answeredMessages += 1;
      if (punctual) {
        punctualPoints += 1;
      }

      updateScoreDisplays();
      renderChatList();
      closeOverlay();
    }

    function closeOverlay() {
      overlayEl.classList.remove("visible");
      openedMessageId = null;
    }

    // ------------------------------
    // Events
    // ------------------------------
    msgCloseBtn.addEventListener("click", closeOverlay);

    overlayEl.addEventListener("click", (e) => {
      if (e.target === overlayEl) {
        closeOverlay();
      }
    });

    // ------------------------------
    // Init
    // ------------------------------
    function init() {
      punctualPoints = 0;
      answeredMessages = 0;
      updateScoreDisplays();
      createRandomMessages();
      renderChatList();
      showIntro();
    }

    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
